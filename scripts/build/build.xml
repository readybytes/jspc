<?xml version="1.0" ?>
<!-- $Id: build.xml meenal $ -->
<project name="JSPC Component" basedir="." default="build" description="Phing build script for JSPC package.">

	<target name="config" description="Load configuration file">
		<property file="build.properties"  override="false" />
	</target>

	
	<target name="build" description="build installable package only" depends="config,get_svn_lastrevision">
		<!-- delete packages -->
		<delete dir="${global.dir.packages}" includeemptydirs="true" />
		
		<mkdir dir="${global.dir.packages}" />
		<mkdir dir="${global.dir.tmp}" />

		<phingcall target="export_from_wc" />
		<!-- Process all build process here -->
		<phing phingfile="com_jspc.xml" inheritAll="true" target="build" />
		<phing phingfile="plg_jspc.xml" inheritAll="true" target="build" />
		<phing phingfile="mod_jspc.xml" inheritAll="true" target="build" />

		<mkdir dir="JSPC-${global.version}.${svn.lastrevision}-Unzip-First" />
		<copy todir="JSPC-${global.version}.${svn.lastrevision}-Unzip-First">
			<fileset dir="${global.dir.packages}">
				<include name="*.zip" />
			</fileset>
		</copy>

			<zip destfile="${global.dir.packages}/JSPC-${global.version}.${svn.lastrevision}-Unzip-First.zip" 
			basedir="JSPC-${global.version}.${svn.lastrevision}-Unzip-First" />

		<delete dir="JSPC-${global.version}.${svn.lastrevision}-Unzip-First" includeemptydirs="true"/>
		<delete dir="${global.dir.tmp}" includeemptydirs="true" />
	</target>


	<!-- Global Target -->
	<target name="export_from_wc" description="Export files from a local working copy" depends="config">
		<copy todir="${global.dir.tmp}">
			<fileset dir="${global.dir.local}">
				<include name="**" />
			</fileset>
		</copy>

		<!-- apply lint -->
		<analyze analyzerPath="/usr/local/bin/joomlaxi/zca" disable="var-ref-notmodified,if-if-else,expr-unused,include-var" >
			<fileset dir="${global.dir.tmp}">
			    <include name="**/*.php"/>
			</fileset>
		</analyze>

		<exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hni xitodo     > ${global.dir.report}/xitodo.txt " escape="false" />
		<exec command="find  ${global.dir.tmp} | xargs -l1 grep -Hni JSITE_PATH > ${global.dir.report}/jsite-path.txt " escape="false" />
		<exec command="find  ${global.dir.tmp} | xargs -l1 egrep -Hn '_REQUEST|_POST|_GET|_SESSION|_GLOBAL' > ${global.dir.report}/post-get-request.txt " escape="false" />

	</target>

	<target name="get_svn_lastrevision" depends="config">
		<svnlastrevision workingcopy="${global.dir.root}" propertyname="svn.lastrevision" />
	</target>
	
</project>
